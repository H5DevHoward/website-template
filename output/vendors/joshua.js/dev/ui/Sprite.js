define(["jquery","joshua/util/Class","modernizr"],function(e,t){var n=t.extend({init:function(t,r){var i=n.get(t);if(i)return i;n._instances.push(this),this.$element=e(t),this._setCss(),this._initProperty(r)}});return n.className="js-sprite",n._instances=[],n._options={firstFrame:0,loop:!1,reverse:!1,fps:24,mode:Modernizr.canvas?"canvas":"background"},n.get=function(t){var r=e(t)[0];for(var i=0;i<n._instances.length;++i){var s=n._instances[i];if(s.$element&&s.$element[0]==r)return s}return null},n.remove=function(e){for(var t=0;t<n._instances.length;++t)if(n._instances[t]==e){n._instances.splice(t,1),e._dispose(),e=null;break}},n.load=function(){for(var e=0;e<n._instances.length;++e)n._instances[e]._load()},n.prototype._setCss=function(){this.$element.find("div").css("display","none")},n.prototype._initProperty=function(t){var r=e.extend({},n._options,{width:this.$element.attr("js-width"),height:this.$element.attr("js-height"),texture:this.$element.attr("js-texture"),frames:this.$element.attr("js-frames"),firstFrame:this.$element.attr("js-first-frame"),lastFrame:this.$element.attr("js-last-frame"),cols:this.$element.attr("js-cols"),loop:this.$element.attr("js-loop")=="true",reverse:this.$element.attr("js-reverse")=="true",fps:this.$element.attr("js-fps"),mode:this.$element.attr("js-mode")},t);this._width=r.width,this._height=r.height,this._texture=r.texture,this._frames=r.frames,this._firstFrame=r.firstFrame,this._lastFrame=r.lastFrame?r.lastFrame:this._frames-1,this._cols=r.cols?r.cols:this._frames,this._loop=r.loop,this._reverse=r.reverse,this._fps=r.fps,this._mode=r.mode,this._onload=r.onload,this._ondone=r.ondone,this._currentIndex=this._reverse?this._lastFrame:this._firstFrame,this._timeDist=1e3/this._fps,this._st=null,this._paused=!0,this._ended=!1,this._loaded=!1},n.prototype._load=function(){switch(this._mode){case"canvas":this._initCanvas();break;case"background":this._initBackground()}},n.prototype._initCanvas=function(){var t=this,n=e(t);if(t._loaded){t._onload&&t._onload();return}t._canvas||(t._canvas=e('<canvas width="'+t._width+'" height="'+t._height+'">').appendTo(t.$element)[0],t._context=t._canvas.getContext("2d")),t._img=e("<img>").one("load",function(){t._loaded=!0,t._onload&&t._onload()}).attr("src",t._texture)[0]},n.prototype._initBackground=function(){var t=this,n=e(t);if(t._loaded){t._onload&&t._onload();return}t.$element.css({"background-image":"url("+t._texture+")","background-position":"0 0"}),t._loaded=!0,t._onload&&t._onload()},n.prototype._renderFrames=function(){var t=this,n=e(t);t._st=setTimeout(function(){t._draw(),t._reverse?--t._currentIndex:++t._currentIndex,!t._reverse&&t._currentIndex==t._lastFrame+1||t._reverse&&t._currentIndex==t._firstFrame-1?t._loop?(t._currentIndex=t._reverse?t._lastFrame:t._firstFrame,t._renderFrames()):(t._ended=!0,t._paused=!0,clearTimeout(t._st),t._ondone&&t._ondone()):t._renderFrames()},t._timeDist)},n.prototype._draw=function(){var e=this._currentIndex%this._cols,t=parseInt(this._currentIndex/this._cols);switch(this._mode){case"canvas":this._context.clearRect(0,0,this._width,this._height),this._context.drawImage(this._img,e*this._width,t*this._height,this._width,this._height,0,0,this._width,this._height);break;case"background":this.$element.css({"background-position":-e*this._width+"px "+(-t*this._height+"px")})}},n.prototype._dispose=function(){e(this).off(),delete this._width,delete this._height,delete this._texture,delete this._frames,delete this._firstFrame,delete this._lastFrame,delete this._cols,delete this._loop,delete this._reverse,delete this._fps,delete this._currentIndex,delete this._timeDist,delete this._st,delete this._paused,delete this._ended,delete this._loaded,delete this.$element,delete this._canvas,delete this._context,delete this._img,delete this._mode},n.prototype.pause=function(){if(!this._loaded)return;if(this._paused)return;if(this._ended)return;this._paused=!0,clearTimeout(this._st)},n.prototype.play=function(){if(!this._loaded)return;if(!this._paused)return;if(this._ended)return;this._paused=!1,this._renderFrames()},n.prototype.replay=function(){if(!this._loaded)return;if(!this._paused)return;this._currentIndex=this._reverse?this._lastFrame:this._firstFrame,this._paused=!1,this._ended=!1,this._renderFrames()},n.prototype.seekTo=function(e){this._ended=!1,this.pause(),e=e<0?0:e,e=e>this._frames?this._frames-1:e,this._currentIndex=e,this._draw()},n.prototype.config=function(e){if(!this._paused)return;this._texture=e.texture?e.texture:this._texture,this._frames=e.frames?e.frames:this._frames,this._firstFrame=e.firstFrame?e.firstFrame:0,this._lastFrame=e.lastFrame?e.lastFrame:this._frames-1,this._cols=e.cols?e.cols:this._frames,this._loop=e.loop?e.loop:!1,this._reverse=e.reverse?e.reverse:!1,this._fps=e.fps?e.fps:24,this._currentIndex=this._reverse?this._lastFrame:this._firstFrame,this._timeDist=1e3/this._fps,this._st=null,this._paused=!0,this._ended=!1,this._loaded=!1},n});